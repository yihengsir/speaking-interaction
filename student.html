<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Student - Speaking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .recording-pulse { animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        mark { background-color: #ccfbf1; color: #0f766e; padding: 0 2px; }
        .cloze-blank { border-bottom: 2px solid #ccc; display: inline-block; min-width: 30px; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">

    <div class="fixed top-0 left-0 w-full bg-gray-900 text-white text-xs p-2 flex justify-between px-4 z-50 shadow-md">
        <span id="conn-status"><i class="fas fa-spinner fa-spin"></i> Connecting...</span>
        <span id="my-name-display" class="font-bold text-yellow-400"></span>
    </div>

    <div id="setup-panel" class="bg-white w-full max-w-sm rounded-xl shadow-lg p-6 mt-20 text-center hidden">
        <h2 class="text-xl font-bold mb-4 text-gray-800">English Speaking Class</h2>
        <input type="text" id="name-input" class="w-full border-b-2 border-indigo-200 p-2 text-center text-lg outline-none mb-6 focus:border-indigo-600 transition" placeholder="Enter your name (e.g., Leo)">
        <button onclick="login()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold shadow hover:bg-indigo-700 transition">Join Class</button>
    </div>

    <div id="main-panel" class="hidden w-full max-w-sm mt-16 flex flex-col gap-4 animate-fade-in">
        
        <div class="bg-white p-4 rounded-xl shadow border-l-4 border-indigo-500">
            <h3 class="text-xs font-bold text-gray-400 uppercase mb-1">üì¢ Topic</h3>
            <p id="topic-display" class="text-gray-800 font-medium text-lg">Waiting for teacher...</p>
        </div>

        <div class="bg-white p-6 rounded-xl shadow flex flex-col items-center relative">
            
            <div id="transcript-box" class="w-full bg-gray-50 p-3 rounded h-32 overflow-y-auto text-sm text-gray-600 mb-4 border border-gray-200">
                (Tap microphone and speak in English...)
            </div>

            <div id="timer" class="text-3xl font-mono font-bold text-gray-300 mb-6 transition-colors">00:00</div>

            <div class="flex gap-6 items-center">
                <button id="btn-record" onclick="toggleRecord()" class="w-20 h-20 bg-red-500 rounded-full text-white text-3xl shadow-lg flex items-center justify-center transition active:scale-95">
                    <i class="fas fa-microphone"></i>
                </button>
                <button id="btn-send" onclick="sendDataChunked()" class="hidden w-20 h-20 bg-green-500 rounded-full text-white text-3xl shadow-lg flex items-center justify-center transition active:scale-95 animate-bounce-in">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            <p id="hint" class="text-xs text-gray-400 mt-4">Tap red button to start</p>
            
            <div id="progress-container" class="w-full mt-4 hidden">
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="progress-bar" class="bg-green-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p id="progress-text" class="text-xs text-center mt-1 text-gray-500">Preparing...</p>
            </div>
        </div>

        <button onclick="openHistory()" class="w-full bg-white border border-gray-200 text-indigo-600 py-3 rounded-xl font-bold shadow-sm hover:bg-indigo-50 transition">
            <i class="fas fa-history mr-2"></i> My Feedback History
        </button>
    </div>

    <div id="history-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden flex flex-col items-center justify-end md:justify-center p-0 md:p-4 z-40">
        <div class="bg-white w-full max-w-sm rounded-t-xl md:rounded-xl overflow-hidden shadow-2xl h-[70vh] flex flex-col">
            <div class="bg-gray-800 p-4 text-white font-bold flex justify-between items-center flex-shrink-0">
                <span><i class="fas fa-book mr-2"></i> Past Reports</span>
                <button onclick="closeHistory()"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-4 overflow-y-auto flex-1 space-y-3" id="history-list">
                </div>
        </div>
    </div>

    <div id="feedback-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden flex items-center justify-center p-4 z-[60]">
        <div class="bg-white w-full max-w-sm rounded-xl overflow-hidden shadow-2xl h-[80vh] flex flex-col">
            <div class="bg-indigo-600 p-4 text-white font-bold flex justify-between items-center flex-shrink-0">
                <span><i class="fas fa-clipboard-check mr-2"></i> Teacher's Report</span>
                <button onclick="closeModal()"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <div class="p-4 overflow-y-auto flex-1 space-y-6">
                <div class="flex justify-center gap-8 border-b pb-4">
                    <div class="text-center">
                        <div class="text-4xl font-extrabold text-indigo-600" id="fb-score">--</div>
                        <div class="text-xs text-gray-500 uppercase font-bold mt-1">Band</div>
                    </div>
                    <div class="text-center">
                        <div class="text-4xl font-extrabold text-purple-600" id="fb-cefr">--</div>
                        <div class="text-xs text-gray-500 uppercase font-bold mt-1">Level</div>
                    </div>
                </div>
                
                <div>
                    <h4 class="font-bold text-gray-800 mb-1">üìù Summary</h4>
                    <div class="bg-gray-50 p-3 rounded text-sm text-gray-700" id="fb-rationale"></div>
                </div>

                <div>
                    <h4 class="font-bold text-blue-700 mb-1">‚ú® Native Polish</h4>
                    <div class="bg-blue-50 p-3 rounded text-sm text-gray-700 leading-relaxed" id="fb-enhancement"></div>
                </div>

                <div>
                    <h4 class="font-bold text-red-700 mb-1">üõ† Corrections</h4>
                    <div class="bg-red-50 p-3 rounded text-sm overflow-x-auto">
                        <table class="w-full text-left" id="fb-errors"></table>
                    </div>
                </div>

                <div>
                    <h4 class="font-bold text-purple-700 mb-1">üåü Model Answer</h4>
                    <div class="bg-purple-50 p-3 rounded text-sm text-gray-700 italic" id="fb-sample"></div>
                </div>
            </div>
            
            <div class="p-3 border-t bg-gray-50 text-center flex-shrink-0">
                <button onclick="closeModal()" class="bg-gray-800 text-white px-8 py-2 rounded-full text-sm font-bold shadow">Close Report</button>
            </div>
        </div>
    </div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const teacherId = urlParams.get('t');
    let peer = null;
    let conn = null;
    let myUUID = localStorage.getItem('stu_uuid') || 'stu_'+Date.now();
    let myName = localStorage.getItem('stu_name') || "";
    let feedbackHistory = JSON.parse(localStorage.getItem('stu_feedback_history')) || [];
    
    let mediaRecorder, audioChunks = [], recognition;
    let isRecording = false;
    let timerInterval;
    let finalTranscript = ""; 

    window.addEventListener('load', () => {
        localStorage.setItem('stu_uuid', myUUID);
        if(myName) loginDirect();
        else document.getElementById('setup-panel').classList.remove('hidden');
    });

    function login() {
        const val = document.getElementById('name-input').value.trim();
        if(!val) return alert("Please enter your name");
        myName = val;
        localStorage.setItem('stu_name', myName);
        loginDirect();
    }

    function loginDirect() {
        document.getElementById('setup-panel').classList.add('hidden');
        document.getElementById('main-panel').classList.remove('hidden');
        document.getElementById('my-name-display').innerText = myName;
        initPeer();
    }

    function initPeer() {
        if(!teacherId) return updateStatus("‚ùå Invalid Link", "bg-red-600");
        updateStatus("üîÑ Connecting...", "bg-yellow-600");
        peer = new Peer();
        
        peer.on('open', () => {
            conn = peer.connect(teacherId, { metadata: { uuid: myUUID, name: myName }, reliable: true });
            
            conn.on('open', () => {
                updateStatus("‚úÖ Connected", "bg-green-600");
                conn.send({ type: 'handshake', uuid: myUUID, name: myName });
            });
            
            conn.on('data', (msg) => {
                if(msg.type === 'ping') {
                    // Respond to teacher's heartbeat
                    conn.send({ type: 'pong' });
                }
                if(msg.type === 'topic') document.getElementById('topic-display').innerText = msg.data;
                if(msg.type === 'ack') completeUpload();
                if(msg.type === 'feedback') {
                    saveAndShowFeedback(msg.data);
                }
            });
            
            conn.on('close', () => updateStatus("üî¥ Disconnected", "bg-red-600"));
        });

        // Auto-reconnect on silent drops
        peer.on('disconnected', () => {
            updateStatus("üîÑ Reconnecting...", "bg-yellow-600");
            setTimeout(() => { if (!peer.destroyed) peer.reconnect(); }, 1000);
        });
    }

    function updateStatus(text, bg) {
        const el = document.getElementById('conn-status');
        el.innerText = text;
        el.parentElement.className = `fixed top-0 left-0 w-full text-white text-xs p-2 flex justify-between px-4 z-50 shadow-md ${bg}`;
    }

    // --- ÂΩïÈü≥ÈÄªËæë ---
    async function toggleRecord() {
        if(!isRecording) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                startRecording(stream);
                startTimer();
                isRecording = true;
                
                const btn = document.getElementById('btn-record');
                btn.innerHTML = '<i class="fas fa-stop"></i>';
                btn.className = "w-20 h-20 bg-gray-800 rounded-full text-white text-3xl shadow-lg flex items-center justify-center recording-pulse";
                document.getElementById('btn-send').classList.add('hidden');
                document.getElementById('timer').classList.replace('text-gray-300', 'text-gray-800');
                
                finalTranscript = "";
                document.getElementById('transcript-box').innerText = "";
            } catch(e) { alert("Microphone access denied. Please use HTTPS."); }
        } else {
            stopRecording();
            stopTimer();
            isRecording = false;
            
            const btn = document.getElementById('btn-record');
            btn.innerHTML = '<i class="fas fa-redo"></i>';
            btn.className = "w-20 h-20 bg-gray-400 rounded-full text-white text-3xl shadow-lg flex items-center justify-center";
            document.getElementById('btn-send').classList.remove('hidden');
            document.getElementById('hint').innerText = "Send or tap gray button to retry";
        }
    }

    function startRecording(stream) {
        audioChunks = [];
        const options = MediaRecorder.isTypeSupported('audio/webm') ? { mimeType: 'audio/webm' } : {};
        mediaRecorder = new MediaRecorder(stream, options);
        mediaRecorder.ondataavailable = e => { if(e.data.size > 0) audioChunks.push(e.data); };
        mediaRecorder.start();

        if('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.continuous = true;
            recognition.interimResults = true;
            
            recognition.onresult = e => {
                let interim = "";
                for(let i=e.resultIndex; i<e.results.length; ++i) {
                    if(e.results[i].isFinal) finalTranscript += e.results[i][0].transcript + " ";
                    else interim += e.results[i][0].transcript;
                }
                document.getElementById('transcript-box').innerText = finalTranscript + interim;
            };
            recognition.onend = () => { if(isRecording) recognition.start(); };
            try { recognition.start(); } catch(e){}
        }
    }

    function stopRecording() {
        if(mediaRecorder) { mediaRecorder.stop(); mediaRecorder.stream.getTracks().forEach(t=>t.stop()); }
        if(recognition) { recognition.onend = null; recognition.stop(); }
    }

    // --- ÂàÜÁâá‰º†ËæìÈÄªËæë ---
    function sendDataChunked() {
        if(!conn || !conn.open) return alert("Not connected to teacher. Please wait or refresh.");
        
        const blob = new Blob(audioChunks, { type: 'audio/webm' });
        const text = document.getElementById('transcript-box').innerText;
        
        const btn = document.getElementById('btn-send');
        btn.classList.add('hidden');
        document.getElementById('progress-container').classList.remove('hidden');
        
        const transferId = Date.now().toString();
        const CHUNK_SIZE = 16 * 1024;
        let offset = 0;
        
        const reader = new FileReader();
        reader.onload = async (e) => {
            const buffer = e.target.result;
            const totalSize = buffer.byteLength;
            
            conn.send({
                type: 'file-start', transferId: transferId, totalSize: totalSize,
                mimeType: 'audio/webm', meta: { uuid: myUUID, name: myName, text: text }
            });

            function sendNextChunk() {
                if(offset < totalSize) {
                    const chunk = buffer.slice(offset, offset + CHUNK_SIZE);
                    conn.send({ type: 'file-chunk', transferId: transferId, chunk: chunk });
                    
                    offset += CHUNK_SIZE;
                    const percent = Math.min(99, Math.round((offset / totalSize) * 100));
                    
                    document.getElementById('progress-bar').style.width = percent + "%";
                    document.getElementById('progress-text').innerText = `Uploading... ${percent}%`;
                    setTimeout(sendNextChunk, 15); 
                } else {
                    conn.send({ type: 'file-end', transferId: transferId });
                    document.getElementById('progress-text').innerText = "Verifying with server...";
                    document.getElementById('progress-bar').classList.add('animate-pulse');
                }
            }
            sendNextChunk();
        };
        reader.readAsArrayBuffer(blob);
    }

    function completeUpload() {
        document.getElementById('progress-bar').style.width = "100%";
        document.getElementById('progress-bar').classList.remove('animate-pulse');
        document.getElementById('progress-text').innerText = "Done!";
        alert("‚úÖ Sent Successfully!");
        resetUI();
    }

    function resetUI() {
        document.getElementById('transcript-box').innerText = "(Tap microphone...)";
        document.getElementById('progress-container').classList.add('hidden');
        document.getElementById('progress-bar').style.width = "0%";
        
        const btn = document.getElementById('btn-record');
        btn.innerHTML = '<i class="fas fa-microphone"></i>';
        btn.className = "w-20 h-20 bg-red-500 rounded-full text-white text-3xl shadow-lg flex items-center justify-center";
        
        document.getElementById('timer').innerText = "00:00";
        document.getElementById('timer').classList.replace('text-gray-800', 'text-gray-300');
    }

    function startTimer() {
        let sec = 0;
        document.getElementById('timer').innerText = "00:00";
        timerInterval = setInterval(() => {
            sec++;
            const m = Math.floor(sec/60).toString().padStart(2,'0');
            const s = (sec%60).toString().padStart(2,'0');
            document.getElementById('timer').innerText = `${m}:${s}`;
        }, 1000);
    }
    function stopTimer() { clearInterval(timerInterval); }

    // --- ÂéÜÂè≤‰∏éÂèçÈ¶àÈÄªËæë ---
    function saveAndShowFeedback(data) {
        const currentTopic = document.getElementById('topic-display').innerText;
        const record = {
            id: Date.now(),
            date: new Date().toLocaleString([], {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'}),
            topic: currentTopic,
            data: data
        };
        // Save to top of history
        feedbackHistory.unshift(record);
        localStorage.setItem('stu_feedback_history', JSON.stringify(feedbackHistory));
        
        showFeedback(data);
    }

    function showFeedback(data) {
        document.getElementById('fb-score').innerText = data.estimated_score;
        document.getElementById('fb-cefr').innerText = data.cefr_level;
        document.getElementById('fb-rationale').innerText = data.score_rationale;
        document.getElementById('fb-enhancement').innerHTML = data.expression_enhancement;
        document.getElementById('fb-sample').innerText = data.sample_answer;
        
        const errTable = document.getElementById('fb-errors');
        errTable.innerHTML = "";
        (data.error_table || []).forEach(e => {
            errTable.innerHTML += `<tr class="border-b border-red-100"><td class="py-1 text-red-600"><del>${e.original}</del></td><td class="py-1 text-green-600">${e.fixed}</td></tr>`;
        });

        document.getElementById('feedback-modal').classList.remove('hidden');
    }
    
    function closeModal() { document.getElementById('feedback-modal').classList.add('hidden'); }

    function openHistory() {
        const list = document.getElementById('history-list');
        list.innerHTML = '';
        if(feedbackHistory.length === 0) {
            list.innerHTML = '<p class="text-center text-gray-400 mt-10">No history available yet.</p>';
        } else {
            feedbackHistory.forEach((item, index) => {
                list.innerHTML += `
                    <div onclick="viewHistoryItem(${index})" class="bg-gray-50 p-3 rounded-lg border border-gray-200 active:bg-gray-200 transition cursor-pointer flex justify-between items-center">
                        <div class="overflow-hidden pr-2">
                            <div class="text-xs text-gray-400 mb-1">${item.date}</div>
                            <div class="text-sm font-bold text-gray-700 truncate">${item.topic}</div>
                        </div>
                        <div class="bg-indigo-100 text-indigo-700 font-bold px-3 py-1 rounded-full text-sm shrink-0">
                            ${item.data.estimated_score}
                        </div>
                    </div>
                `;
            });
        }
        document.getElementById('history-modal').classList.remove('hidden');
    }

    function closeHistory() { document.getElementById('history-modal').classList.add('hidden'); }

    function viewHistoryItem(index) {
        showFeedback(feedbackHistory[index].data);
    }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å­¦ç”Ÿç«¯</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .recording-pulse { animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">

    <div class="fixed top-0 left-0 w-full bg-gray-900 text-white text-xs p-2 flex justify-between px-4 z-50">
        <span id="conn-status"><i class="fas fa-spinner fa-spin"></i> è¿æ¥ä¸­...</span>
        <span id="my-name-display" class="font-bold text-yellow-400"></span>
    </div>

    <div id="setup-panel" class="bg-white w-full max-w-sm rounded-xl shadow-lg p-6 mt-16 text-center hidden">
        <h2 class="text-xl font-bold mb-4 text-gray-800">åŠ å…¥å£è¯­è¯¾å ‚</h2>
        <input type="text" id="name-input" class="w-full border-b-2 border-indigo-200 p-2 text-center text-lg outline-none mb-6 focus:border-indigo-600" placeholder="è¯·è¾“å…¥ä½ çš„åå­—">
        <button onclick="login()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold shadow hover:bg-indigo-700">è¿›å…¥</button>
    </div>

    <div id="main-panel" class="hidden w-full max-w-sm mt-12 flex flex-col gap-4">
        
        <div class="bg-white p-4 rounded-xl shadow border-l-4 border-indigo-500">
            <h3 class="text-xs font-bold text-gray-400 uppercase mb-1">ğŸ“¢ é¢˜ç›®</h3>
            <p id="topic-display" class="text-gray-800 font-medium">ç­‰å¾…è€å¸ˆå‘å¸ƒ...</p>
        </div>

        <div class="bg-white p-6 rounded-xl shadow flex flex-col items-center">
            <div id="transcript-box" class="w-full bg-gray-50 p-3 rounded h-32 overflow-y-auto text-sm text-gray-600 mb-4 border border-gray-200">
                (ç‚¹å‡»å½•éŸ³ï¼Œä¸­è‹±æ–‡å‡å¯è¯†åˆ«...)
            </div>

            <div id="timer" class="text-3xl font-mono font-bold text-gray-300 mb-6">00:00</div>

            <div class="flex gap-6 items-center">
                <button id="btn-record" onclick="toggleRecord()" class="w-20 h-20 bg-red-500 rounded-full text-white text-3xl shadow-lg flex items-center justify-center transition active:scale-95">
                    <i class="fas fa-microphone"></i>
                </button>
                <button id="btn-send" onclick="sendData()" class="hidden w-20 h-20 bg-green-500 rounded-full text-white text-3xl shadow-lg flex items-center justify-center transition active:scale-95">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            <p id="hint" class="text-xs text-gray-400 mt-4">ç‚¹å‡»çº¢è‰²æŒ‰é’®å¼€å§‹</p>
        </div>
    </div>

    <div id="feedback-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white w-full max-w-sm rounded-xl overflow-hidden shadow-2xl animate-fade-in">
            <div class="bg-indigo-600 p-3 text-white font-bold flex justify-between">
                <span><i class="fas fa-comment-dots mr-1"></i> è€å¸ˆç‚¹è¯„</span>
                <button onclick="closeModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4 max-h-[70vh] overflow-y-auto">
                <div class="flex justify-around mb-4 border-b pb-4">
                    <div class="text-center"><div class="text-3xl font-bold text-indigo-600" id="fb-score">--</div><div class="text-xs text-gray-500">SCORE</div></div>
                    <div class="text-center"><div class="text-3xl font-bold text-purple-600" id="fb-cefr">--</div><div class="text-xs text-gray-500">CEFR</div></div>
                </div>
                <div id="fb-content" class="text-sm text-gray-700 space-y-3"></div>
            </div>
        </div>
    </div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const teacherId = urlParams.get('t');
    let peer = null;
    let conn = null;
    let myUUID = localStorage.getItem('stu_uuid') || 'stu_'+Date.now();
    let myName = localStorage.getItem('stu_name') || "";
    
    // å½•éŸ³å˜é‡
    let mediaRecorder, audioChunks = [], recognition, isRecording = false, timerInterval;

    // åˆå§‹åŒ–
    window.addEventListener('load', () => {
        localStorage.setItem('stu_uuid', myUUID);
        if(myName) loginDirect();
        else document.getElementById('setup-panel').classList.remove('hidden');
    });

    function login() {
        const val = document.getElementById('name-input').value.trim();
        if(!val) return alert("è¯·è¾“å…¥åå­—");
        myName = val;
        localStorage.setItem('stu_name', myName);
        loginDirect();
    }

    function loginDirect() {
        document.getElementById('setup-panel').classList.add('hidden');
        document.getElementById('main-panel').classList.remove('hidden');
        document.getElementById('my-name-display').innerText = myName;
        initPeer();
    }

    function initPeer() {
        if(!teacherId) return updateStatus("âŒ æ— æ•ˆé“¾æ¥", "bg-red-600");
        updateStatus("ğŸ”„ è¿æ¥ä¸­...", "bg-yellow-600");
        
        peer = new Peer();
        peer.on('open', () => {
            conn = peer.connect(teacherId, { metadata: { uuid: myUUID, name: myName } });
            
            conn.on('open', () => {
                updateStatus("âœ… å·²è¿æ¥", "bg-green-600");
                // å¼ºåˆ¶æ¡æ‰‹ï¼Œé˜²æ­¢åå­— undefined
                conn.send({ type: 'handshake', uuid: myUUID, name: myName });
            });

            conn.on('data', (msg) => {
                if(msg.type === 'topic') document.getElementById('topic-display').innerText = msg.data;
                if(msg.type === 'ack') { alert("âœ… å‘é€æˆåŠŸï¼"); resetUI(); }
                if(msg.type === 'feedback') showFeedback(msg.data);
            });

            conn.on('close', () => updateStatus("ğŸ”´ æ–­å¼€", "bg-red-600"));
        });
    }

    function updateStatus(text, bg) {
        const el = document.getElementById('conn-status');
        el.innerText = text;
        el.parentElement.className = `fixed top-0 left-0 w-full text-white text-xs p-2 flex justify-between px-4 z-50 ${bg}`;
    }

    // å½•éŸ³é€»è¾‘ (åŒè¯­è¯†åˆ«)
    async function toggleRecord() {
        if(!isRecording) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                startRecording(stream);
                startTimer();
                isRecording = true;
                // UI
                const btn = document.getElementById('btn-record');
                btn.innerHTML = '<i class="fas fa-stop"></i>';
                btn.className = "w-20 h-20 bg-gray-800 rounded-full text-white text-3xl shadow-lg flex items-center justify-center recording-pulse";
                document.getElementById('btn-send').classList.add('hidden');
            } catch(e) { alert("æ— æ³•å½•éŸ³ï¼Œè¯·æ£€æŸ¥æƒé™"); }
        } else {
            stopRecording();
            stopTimer();
            isRecording = false;
            // UI
            const btn = document.getElementById('btn-record');
            btn.innerHTML = '<i class="fas fa-redo"></i>';
            btn.className = "w-20 h-20 bg-gray-400 rounded-full text-white text-3xl shadow-lg flex items-center justify-center";
            document.getElementById('btn-send').classList.remove('hidden');
            document.getElementById('hint').innerText = "æ»¡æ„è¯·å‘é€ï¼Œç‚¹å‡»ç°è‰²æŒ‰é’®é‡å½•";
        }
    }

    function startRecording(stream) {
        audioChunks = [];
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
        mediaRecorder.ondataavailable = e => { if(e.data.size > 0) audioChunks.push(e.data); };
        mediaRecorder.start();

        // è¯†åˆ«é€»è¾‘ï¼šè®¾ç½®ä¸ºä¸­æ–‡ (cmn-Hans-CN)ï¼Œé€šå¸¸ä¹Ÿèƒ½è¯†åˆ«ç®€å•è‹±æ–‡
        // å¦‚æœæƒ³çº¯è‹±æ–‡ï¼Œå¯æ”¹ä¸º 'en-US'
        if('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'cmn-Hans-CN'; // è®¾ç½®ä¸ºä¸­æ–‡ï¼Œä»¥æ”¯æŒä¸­è‹±æ··æ‚ï¼ˆå–å†³äºå¼•æ“ï¼‰
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.onresult = e => {
                let txt = "";
                for(let i=e.resultIndex; i<e.results.length; ++i) txt += e.results[i][0].transcript;
                document.getElementById('transcript-box').innerText = txt;
            };
            recognition.start();
        }
    }

    function stopRecording() {
        if(mediaRecorder) { mediaRecorder.stop(); mediaRecorder.stream.getTracks().forEach(t=>t.stop()); }
        if(recognition) recognition.stop();
    }

    function sendData() {
        if(!conn || !conn.open) return alert("æœªè¿æ¥è€å¸ˆ");
        
        const blob = new Blob(audioChunks, { type: 'audio/webm' });
        const text = document.getElementById('transcript-box').innerText;

        // æ ¸å¿ƒä¿®å¤ï¼šå°† Blob è½¬æ¢ä¸º ArrayBuffer å‘é€
        const reader = new FileReader();
        reader.onload = function(evt) {
            const buffer = evt.target.result;
            conn.send({
                type: 'submission',
                id: Date.now(),
                uuid: myUUID,
                name: myName, // å†æ¬¡å¼ºåˆ¶æºå¸¦åå­—
                text: text,
                file: buffer // å‘é€äºŒè¿›åˆ¶ Buffer
            });
            document.getElementById('btn-send').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        };
        reader.readAsArrayBuffer(blob);
    }

    function resetUI() {
        document.getElementById('transcript-box').innerText = "(ç‚¹å‡»å½•éŸ³...)";
        document.getElementById('btn-send').classList.add('hidden');
        document.getElementById('btn-send').innerHTML = '<i class="fas fa-paper-plane"></i>';
        const btn = document.getElementById('btn-record');
        btn.innerHTML = '<i class="fas fa-microphone"></i>';
        btn.className = "w-20 h-20 bg-red-500 rounded-full text-white text-3xl shadow-lg flex items-center justify-center";
        document.getElementById('timer').innerText = "00:00";
    }

    function startTimer() {
        let sec = 0;
        document.getElementById('timer').innerText = "00:00";
        timerInterval = setInterval(() => {
            sec++;
            const m = Math.floor(sec/60).toString().padStart(2,'0');
            const s = (sec%60).toString().padStart(2,'0');
            document.getElementById('timer').innerText = `${m}:${s}`;
        }, 1000);
    }
    function stopTimer() { clearInterval(timerInterval); }

    function showFeedback(data) {
        document.getElementById('fb-score').innerText = data.score;
        document.getElementById('fb-cefr').innerText = data.cefr;
        document.getElementById('fb-content').innerHTML = `
            <div class="bg-gray-50 p-2 rounded mb-2"><strong>å»ºè®®ï¼š</strong>${data.rationale}</div>
            <div class="bg-blue-50 p-2 rounded"><strong>æ¶¦è‰²ï¼š</strong>${data.polishing}</div>
        `;
        document.getElementById('feedback-modal').classList.remove('hidden');
    }
    function closeModal() { document.getElementById('feedback-modal').classList.add('hidden'); }
</script>
</body>
</html>

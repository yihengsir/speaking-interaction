<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å­¦ç”Ÿç«¯ - é›…æ€å£è¯­</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .modal { background: rgba(0,0,0,0.5); }
        .recording-pulse { animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col font-sans">

    <div id="status-bar" class="bg-gray-800 text-white p-2 text-xs flex justify-between items-center sticky top-0 z-10 shadow">
        <span id="conn-status"><i class="fas fa-spinner fa-spin"></i> è¿æ¥ä¸­...</span>
        <span id="my-name-display" class="font-bold"></span>
    </div>

    <div class="p-4 flex-1 flex flex-col max-w-md mx-auto w-full">
        
        <div id="setup-panel" class="bg-white p-6 rounded-xl shadow-lg mt-10 text-center hidden">
            <h2 class="text-xl font-bold mb-4 text-indigo-700">æ¬¢è¿åŠ å…¥è¯¾å ‚</h2>
            <input type="text" id="name-input" class="w-full border-b-2 border-indigo-200 p-2 text-center text-lg outline-none mb-6" placeholder="è¯·è¾“å…¥ä½ çš„åå­—">
            <button onclick="saveNameAndConnect()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold shadow hover:bg-indigo-700">è¿›å…¥è¯¾å ‚</button>
        </div>

        <div id="main-panel" class="hidden flex flex-col gap-4">
            
            <div class="bg-white p-4 rounded-xl shadow border-l-4 border-indigo-500">
                <h3 class="text-xs font-bold text-gray-400 uppercase mb-1">ğŸ“¢ å½“å‰é¢˜ç›®</h3>
                <p id="topic-display" class="text-gray-800 font-medium text-lg min-h-[3rem]">ç­‰å¾…è€å¸ˆå‘å¸ƒé¢˜ç›®...</p>
            </div>

            <div class="bg-white p-6 rounded-xl shadow flex flex-col items-center">
                <div id="transcript-box" class="w-full bg-gray-50 p-3 rounded h-32 overflow-y-auto text-sm text-gray-600 mb-4 border border-gray-100">
                    (ç‚¹å‡»å½•éŸ³ï¼Œæ–‡å­—ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ...)
                </div>

                <div id="timer" class="text-2xl font-mono font-bold text-gray-300 mb-4">00:00</div>

                <div class="flex gap-6 items-center">
                    <button id="btn-record" onclick="toggleRecord()" class="w-16 h-16 bg-red-500 rounded-full text-white text-2xl shadow-lg flex items-center justify-center transition active:scale-95">
                        <i class="fas fa-microphone"></i>
                    </button>
                    
                    <button id="btn-send" onclick="sendSubmission()" class="hidden w-16 h-16 bg-green-500 rounded-full text-white text-2xl shadow-lg flex items-center justify-center transition active:scale-95">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <p id="action-hint" class="text-xs text-gray-400 mt-3">ç‚¹å‡»çº¢è‰²æŒ‰é’®å¼€å§‹</p>
            </div>
        </div>
    </div>

    <div id="feedback-modal" class="modal fixed inset-0 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white w-full max-w-sm rounded-xl shadow-2xl overflow-hidden animate-bounce-in">
            <div class="bg-indigo-600 p-3 text-white flex justify-between items-center">
                <span class="font-bold"><i class="fas fa-robot mr-1"></i> è€å¸ˆå‘æ¥çš„ç‚¹è¯„</span>
                <button onclick="closeModal()" class="text-white hover:text-gray-200"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4 max-h-[70vh] overflow-y-auto">
                <div class="flex justify-around mb-4 border-b pb-2">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-indigo-600" id="fb-score">--</div>
                        <div class="text-xs text-gray-500">SCORE</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-purple-600" id="fb-cefr">--</div>
                        <div class="text-xs text-gray-500">CEFR</div>
                    </div>
                </div>
                <div class="mb-4">
                    <h4 class="font-bold text-gray-700 text-sm mb-1">ğŸ’¡ æ”¹è¿›å»ºè®®</h4>
                    <div id="fb-rationale" class="text-sm text-gray-600 bg-gray-50 p-2 rounded"></div>
                </div>
                <div class="mb-4">
                    <h4 class="font-bold text-gray-700 text-sm mb-1">âœï¸ åœ°é“è¡¨è¾¾</h4>
                    <div id="fb-polishing" class="text-sm text-gray-600 leading-relaxed"></div>
                </div>
            </div>
            <div class="p-3 bg-gray-50 text-center border-t">
                <button onclick="closeModal()" class="bg-indigo-600 text-white px-6 py-2 rounded-full text-sm font-bold shadow">æ”¶åˆ°</button>
            </div>
        </div>
    </div>

<script>
    // ===== å…¨å±€å˜é‡ =====
    const urlParams = new URLSearchParams(window.location.search);
    const teacherId = urlParams.get('t');
    let peer = null;
    let conn = null;
    let myUUID = localStorage.getItem('student_uuid');
    let myName = localStorage.getItem('student_name');

    // å½•éŸ³ç›¸å…³
    let mediaRecorder, audioChunks = [], recognition;
    let isRecording = false;
    let timerInterval;

    // ===== åˆå§‹åŒ–é€»è¾‘ =====
    window.addEventListener('load', () => {
        if (!myUUID) {
            myUUID = 'stu_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('student_uuid', myUUID);
        }

        if (myName) {
            initPeer();
        } else {
            document.getElementById('setup-panel').classList.remove('hidden');
        }
    });

    function saveNameAndConnect() {
        const input = document.getElementById('name-input').value.trim();
        if(!input) return alert("è¯·è¾“å…¥åå­—");
        myName = input;
        localStorage.setItem('student_name', myName);
        document.getElementById('setup-panel').classList.add('hidden');
        initPeer();
    }

    // ===== WebRTC é€šä¿¡ =====
    function initPeer() {
        if (!teacherId) return updateStatus("âŒ æ— æ•ˆé“¾æ¥", "bg-red-500");
        document.getElementById('main-panel').classList.remove('hidden');
        document.getElementById('my-name-display').innerText = myName;

        peer = new Peer(null);
        
        peer.on('open', () => {
            connectToTeacher();
        });

        peer.on('error', () => updateStatus("âš ï¸ è¿æ¥å‡ºé”™", "bg-red-500"));
    }

    function connectToTeacher() {
        updateStatus("ğŸ”„ è¿æ¥ä¸­...", "bg-yellow-500");
        
        // å…³é”®ï¼šå‘é€ uuid ä¾›è€å¸ˆç«¯è¯†åˆ«
        conn = peer.connect(teacherId, {
            metadata: { name: myName, uuid: myUUID },
            serialization: 'json'
        });

        conn.on('open', () => {
            updateStatus("âœ… å·²è¿æ¥", "bg-green-500");
        });

        conn.on('close', () => updateStatus("ğŸ”´ å·²æ–­å¼€", "bg-gray-500"));

        conn.on('data', (msg) => {
            // 1. é¢˜ç›®åŒæ­¥
            if (msg.type === 'topic') {
                document.getElementById('topic-display').innerText = msg.data;
            }
            // 2. æ¥æ”¶åé¦ˆ
            if (msg.type === 'feedback') {
                showFeedback(msg.data);
            }
            // 3. æäº¤ç¡®è®¤ (ACK)
            if (msg.type === 'ack') {
                // æ”¶åˆ°è€å¸ˆç¡®è®¤ï¼Œåœæ­¢ loading
                alert("âœ… è€å¸ˆå·²æ”¶åˆ°ä½ çš„æäº¤ï¼");
                resetUI();
            }
        });
    }

    function updateStatus(text, bgClass) {
        const el = document.getElementById('conn-status');
        const bar = document.getElementById('status-bar');
        el.innerText = text;
        bar.className = `p-2 text-xs flex justify-between items-center sticky top-0 z-10 shadow text-white ${bgClass}`;
    }

    // ===== å½•éŸ³ä¸æäº¤ =====
    async function toggleRecord() {
        if (!isRecording) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                startRecording(stream);
            } catch (e) {
                alert("æ— æ³•å½•éŸ³ï¼Œè¯·æ£€æŸ¥æƒé™ (éœ€HTTPS)");
            }
        } else {
            stopRecording();
        }
    }

    function startRecording(stream) {
        audioChunks = [];
        const options = MediaRecorder.isTypeSupported('audio/webm') ? { mimeType: 'audio/webm' } : {};
        mediaRecorder = new MediaRecorder(stream, options);
        mediaRecorder.ondataavailable = e => { if(e.data.size>0) audioChunks.push(e.data); };
        mediaRecorder.start();

        // è¯­éŸ³è¯†åˆ«
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.onresult = (e) => {
                let text = "";
                for(let i=e.resultIndex; i<e.results.length; ++i) text += e.results[i][0].transcript;
                document.getElementById('transcript-box').innerText = text;
            };
            recognition.start();
        }

        isRecording = true;
        // UI æ›´æ–°
        document.getElementById('btn-record').innerHTML = '<i class="fas fa-stop"></i>';
        document.getElementById('btn-record').classList.add('recording-pulse', 'bg-gray-800');
        document.getElementById('btn-record').classList.remove('bg-red-500');
        document.getElementById('btn-send').classList.add('hidden');
        document.getElementById('timer').classList.replace('text-gray-300', 'text-gray-800');
        
        let sec = 0;
        document.getElementById('timer').innerText = "00:00";
        timerInterval = setInterval(() => {
            sec++;
            const m = Math.floor(sec/60).toString().padStart(2,'0');
            const s = (sec%60).toString().padStart(2,'0');
            document.getElementById('timer').innerText = `${m}:${s}`;
        }, 1000);
    }

    function stopRecording() {
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(t => t.stop());
        if(recognition) recognition.stop();
        clearInterval(timerInterval);
        isRecording = false;

        // UI æ›´æ–°
        document.getElementById('btn-record').innerHTML = '<i class="fas fa-redo"></i>'; // é‡å½•
        document.getElementById('btn-record').classList.remove('recording-pulse', 'bg-gray-800');
        document.getElementById('btn-record').classList.add('bg-gray-400'); // ç°è‰²
        document.getElementById('btn-send').classList.remove('hidden');
        document.getElementById('action-hint').innerText = "æ»¡æ„è¯·å‘é€ï¼Œç‚¹å‡»ç°è‰²æŒ‰é’®é‡å½•";
    }

    function sendSubmission() {
        if (!conn || !conn.open) return alert("æœªè¿æ¥åˆ°è€å¸ˆ");
        
        const blob = new Blob(audioChunks, { type: 'audio/webm' });
        const text = document.getElementById('transcript-box').innerText;
        
        // å‘é€æ•°æ®
        conn.send({
            type: 'submission',
            id: Date.now(), // ç»™æ¶ˆæ¯ä¸€ä¸ªIDç”¨äºå›æ‰§
            text: text,
            blob: blob,
            timestamp: Date.now()
        });

        // UI åé¦ˆ
        document.getElementById('btn-send').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    }

    function resetUI() {
        document.getElementById('transcript-box').innerText = "(ç‚¹å‡»å½•éŸ³...)";
        document.getElementById('btn-send').innerHTML = '<i class="fas fa-paper-plane"></i>';
        document.getElementById('btn-send').classList.add('hidden');
        document.getElementById('btn-record').classList.remove('bg-gray-400');
        document.getElementById('btn-record').classList.add('bg-red-500');
        document.getElementById('btn-record').innerHTML = '<i class="fas fa-microphone"></i>';
        document.getElementById('timer').innerText = "00:00";
        document.getElementById('timer').classList.replace('text-gray-800', 'text-gray-300');
    }

    // ===== å¼¹çª—é€»è¾‘ =====
    function showFeedback(data) {
        document.getElementById('fb-score').innerText = data.score;
        document.getElementById('fb-cefr').innerText = data.cefr;
        document.getElementById('fb-rationale').innerText = data.rationale;
        document.getElementById('fb-polishing').innerHTML = data.polishing.replace(/\n/g, '<br>');
        document.getElementById('feedback-modal').classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('feedback-modal').classList.add('hidden');
    }
</script>
</body>
</html>
